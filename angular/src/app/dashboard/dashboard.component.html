<div class="min-vh-100 pb-5 dashboard-vision">

  <!-- Toast de Notificaci√≥n de Stage -->
  <div *ngIf="stageNotification?.visible"
    class="stage-toast position-fixed top-0 end-0 m-3 p-3 rounded-3 shadow-lg d-flex align-items-center gap-3"
    [class.toast-warning]="stageNotification?.color === 'warning'"
    [class.toast-success]="stageNotification?.color === 'success'"
    [class.toast-danger]="stageNotification?.color === 'danger'"
    style="z-index: 9999; min-width: 320px; backdrop-filter: blur(12px); animation: slideInRight 0.4s ease-out;">
    <ion-icon [name]="stageNotification?.icon" class="fs-3 flex-shrink-0"></ion-icon>
    <div class="flex-grow-1">
      <div class="fw-bold text-sm">Motor de An√°lisis</div>
      <div class="text-sm opacity-90">{{ stageNotification?.message }}</div>
    </div>
    <ion-icon name="close-outline" class="pointer opacity-50" (click)="stageNotification = null"></ion-icon>
  </div>

  <!-- Header Branding -->
  <header class="d-flex align-items-center justify-content-between px-4 py-3 border-bottom border-white-10">
    <div class="d-flex align-items-center gap-2">
      <ion-icon name="settings-outline" class="text-primary fs-4"></ion-icon>
      <h1 class="text-white fw-medium mb-0 fs-5">An√°lisis Inteligente en Curso</h1>
    </div>
    <div class="user-profile">
      <ion-icon name="person-circle-outline" class="text-success fs-3"></ion-icon>
    </div>
  </header>

  <main class="container-fluid px-4 py-3">
    <ng-container *ngIf="isHunting; else noHunt">
      <!-- Status Bar -->
      <div class="d-flex align-items-center gap-4 mb-4">
        <div class="d-flex align-items-center gap-2">
          <span class="text-white-50 text-sm fw-bold">Estado:</span>
          <div class="status-indicator d-flex align-items-center gap-2">
            <div class="status-dot pulsing"></div>
            <span class="text-success fw-bold text-sm">ACTIVO</span>
            <span class="text-white-50 text-sm">(Multi-crypto scanning)</span>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="text-white-50 text-sm">Tiempo activo</span>
          <span class="text-white fw-bold text-sm">{{ analysisTime }}</span>
        </div>

        <button *ngIf="currentSession" class="btn btn-danger-vision btn-sm px-3 rounded-pill ms-auto"
          (click)="finalizeHunt()">
          <ion-icon name="stop-circle-outline" class="me-1"></ion-icon>
          Finalizar cacer√≠a
        </button>
      </div>

      <div class="service-box bg-dark-soft border border-white-10 rounded-3 p-4 mb-3 position-relative">
        <div class="row align-items-center">
          <div class="col-md-6 border-end border-white-10">
            <div class="d-flex align-items-center gap-2 mb-2">
              <ion-icon name="checkbox-outline" class="text-success"></ion-icon>
              <span class="text-white fw-bold text-sm">√öltima se√±al del motor:</span>
            </div>
            <ul class="list-unstyled ms-4 mb-0">
              <li class="text-white-50 text-sm d-flex align-items-start gap-2">
                <span class="text-white">‚Ä¢</span>
                <span class="fw-medium text-white">{{ lastMotorSignal || 'Esperando confirmaci√≥n del motor...' }}</span>
              </li>
            </ul>
          </div>
          <div class="col-md-6 ps-4">
            <div class="d-flex align-items-center gap-2 mb-2">
              <ion-icon name="earth-outline" class="text-info"></ion-icon>
              <span class="text-white fw-bold text-sm">√öltima noticia relevante:</span>
            </div>
            <div
              class="news-badge d-inline-flex align-items-center gap-2 px-2 py-1 bg-dark-accent border border-white-10 rounded-2 ms-4">
              <ion-icon name="newspaper-outline" class="text-white-50 fs-xs"></ion-icon>
              <span class="text-white text-xs fw-bold">{{ lastNewsTitle || 'No hay noticias recientes' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Ranking Panel (Phase 3) -->
      <div *ngIf="topOpportunities.length > 0" class="ranking-panel mb-4">
        <div class="d-flex align-items-center gap-2 mb-3">
          <ion-icon name="trophy-outline" class="text-warning"></ion-icon>
          <span class="text-white fw-bold text-sm">üèÜ TOP OPORTUNIDADES (RANKING REAL-TIME)</span>
        </div>
        <div class="row g-2">
          <div *ngFor="let opp of topOpportunities; let i = index" class="col-6 col-md-4">
            <div class="opp-card p-3 rounded-3 border border-white-10 bg-dark-deep h-100 glow-on-hover">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge" [class.bg-success]="opp.direction === 'LONG'"
                  [class.bg-danger]="opp.direction === 'SHORT'" style="font-size: 10px; padding: 2px 6px;">
                  {{ opp.direction }}
                </span>
                <span class="text-white-50" style="font-size: 10px;">#{{ i + 1 }}</span>
              </div>
              <div class="d-flex align-items-baseline gap-2 mb-1">
                <h4 class="text-white fw-bold mb-0" style="font-size: 1rem;">{{ opp.symbol }}</h4>
                <span class="text-success fw-bold" style="font-size: 0.8rem;">{{ opp.score }} pts</span>
              </div>
              <div class="text-white-50 mb-2" style="font-size: 0.75rem;">$ {{ opp.price | number:'1.2-8' }}</div>
              <div class="text-white opacity-75 line-clamp-2" style="font-size: 0.7rem; line-height: 1.2;">{{ opp.reason
                }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scanner List -->
      <div class="market-scanner-section mb-4">
        <div class="d-flex align-items-center gap-2 mb-3">
          <ion-icon name="search-outline" class="text-white-50"></ion-icon>
          <span class="text-white-50 text-sm fw-bold">Analizando mercado en tiempo real</span>
        </div>

        <div class="scanner-list ps-3 border-start border-white-10">
          <!-- Renderizado din√°mico real -->
          <div *ngFor="let m of marketAnalyses" class="scanner-item d-flex align-items-center gap-2 mb-1">
            <span class="text-warning">‚Ä¢</span>
            <span class="text-primary fw-bold text-sm">{{ m.symbol }}</span>
            <span class="text-white-50 text-sm">‚Üí</span>
            <span class="text-primary fw-bold text-sm">RSI {{ m.rsi }}</span>
            <span class="text-white-50 text-sm">| {{ m.description }}</span>
          </div>
        </div>
      </div>

      <!-- Chart Overlay Area -->
      <div
        class="chart-container-vision position-relative rounded-3 overflow-hidden border border-white-10 bg-dark-deep"
        style="min-height: 500px;">
        <div #chartContainer id="tradingview-chart" class="w-100 h-100"></div>

        <!-- Oportunidad Overlay -->
        <div *ngIf="currentOpportunity"
          class="opportunity-alert-box position-absolute top-50 start-50 translate-middle p-4 rounded-4 shadow-xl glow-primary">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
              <ion-icon name="radio-button-on-outline" class="text-danger-custom"></ion-icon>
              <span class="text-white fw-bold text-xs tracking-widest">OPORTUNIDAD DETECTADA</span>
            </div>
            <ion-icon name="close-outline" class="text-white-50 pointer" (click)="dismissOpportunity()"></ion-icon>
          </div>

          <div class="text-center py-2">
            <h2 class="text-white fw-bold mb-3 d-flex align-items-center justify-content-center gap-2">
              <ion-icon name="checkmark-circle" class="text-success fs-1"></ion-icon>
              COMPRA AQU√ç!
            </h2>
            <p class="text-white fw-medium mb-1">
              {{ currentOpportunity.symbol }} <span class="text-white-50 fw-normal ms-1">(confianza {{
                currentOpportunity.confidence }}%)</span>
            </p>
            <div *ngIf="currentOpportunity.entryMin" class="text-primary-light fw-bold mb-4" style="font-size: 0.9rem;">
              üéØ Zona: ${{ currentOpportunity.entryMin | number:'1.2-2' }} - ${{ currentOpportunity.entryMax |
              number:'1.2-2' }}
            </div>

            <button class="btn btn-success-vision w-100 py-2 rounded-3 fw-bold fs-6" (click)="goToTrade()">
              Ir al Mercado
            </button>
          </div>
        </div>
      </div>

      <!-- Consola de An√°lisis -->
      <div class="mb-3 mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2 px-2">
          <h3 class="text-white fw-bold mb-0">üîç Consola de An√°lisis</h3>
          <span class="badge bg-dark text-white">{{ analysisLogs.length }} eventos</span>
        </div>

        <div class="bg-dark rounded-3 p-3 overflow-auto" style="max-height: 400px; font-family: monospace;">
          <div *ngFor="let log of analysisLogs" class="mb-2 pb-2 border-bottom border-white-10 log-entry">
            <div class="d-flex align-items-start gap-2">
              <span class="text-white-50 text-xs mt-1" style="min-width: 65px;">{{ log.timestamp | date:'HH:mm:ss'
                }}</span>

              <div
                class="log-icon-wrapper rounded-circle flex-shrink-0 d-flex align-items-center justify-content-center"
                [style.background-color]="getLogColor(log) + '22'"
                [style.border]="'1px solid ' + getLogColor(log) + '44'" style="width: 24px; height: 24px;">
                <ion-icon [name]="getSignalIcon(log)" [style.color]="getLogColor(log)"
                  style="font-size: 14px;"></ion-icon>
              </div>

              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <span *ngIf="log.symbol"
                    class="badge bg-dark-accent border border-white-10 text-primary-light text-xs">{{ log.symbol
                    }}</span>
                  <span class="text-sm fw-medium" [style.color]="getLogColor(log)">{{ log.message }}</span>
                </div>

                <!-- Technical Metadata (Phase 3) -->
                <div *ngIf="log.dataJson" class="metadata-row d-flex flex-wrap gap-3 mt-1 opacity-60">
                  <ng-container *ngLet="parseJson(log.dataJson) as data">
                    <span *ngIf="data?.rsi" class="text-xs d-flex align-items-center gap-1">
                      <ion-icon name="pulse-outline"></ion-icon> RSI: {{ data.rsi | number:'1.1-1' }}
                    </span>
                    <span *ngIf="data?.adx" class="text-xs d-flex align-items-center gap-1">
                      <ion-icon name="trending-up-outline"></ion-icon> ADX: {{ data.adx | number:'1.1-1' }}
                    </span>
                    <span *ngIf="data?.regime" class="text-xs d-flex align-items-center gap-1 text-info">
                      <ion-icon name="layers-outline"></ion-icon> {{ data.regime }}
                    </span>
                    <span *ngIf="data?.reason" class="text-xs italic opacity-75">
                      {{ data.reason }}
                    </span>
                    <span *ngIf="data?.entryMin" class="text-xs fw-bold text-primary-light">
                      üéØ Zona: ${{ data.entryMin | number:'1.2-2' }}-${{ data.entryMax | number:'1.2-2' }}
                    </span>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="analysisLogs.length === 0" class="text-white-50 text-center py-3">
            <ion-icon name="scan-outline" class="fs-2 mb-2"></ion-icon>
            <p class="mb-0">Esperando an√°lisis del mercado...</p>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #noHunt>
      <div class="empty-state-vision text-center py-5">
        <div class="icon-circle mb-4 mx-auto glow-warning">
          <ion-icon name="eye-off-outline" class="text-warning fs-1"></ion-icon>
        </div>
        <h2 class="text-white fw-bold mb-3">Sin estrategia activa</h2>
        <p class="text-white-50 mb-4 mx-auto" style="max-width: 400px;">
          Configur√° una nueva estrategia de cacer√≠a para comenzar el an√°lisis en tiempo real y detectar oportunidades de
          mercado.
        </p>
        <app-glass-button variant="warning" class="px-5 py-3" (click)="onQuickTrade()">
          üöÄ COMENZAR CACER√çA
        </app-glass-button>
      </div>
    </ng-template>

    <!-- Botonera Inferior -->
    <div class="d-flex gap-3 mt-4">
      <app-glass-button variant="primary" class="flex-grow-1 py-3" (click)="onQuickTrade()" *ngIf="!isHunting">
        ‚ö° CONFIGURAR TRADE
      </app-glass-button>
      <app-glass-button variant="outline" class="flex-grow-1 py-3" (click)="onOpenAdvanced()">
        üìä AVANZADO
      </app-glass-button>
    </div>
  </main>

  <!-- Di√°logo de Confirmaci√≥n -->
  <app-dialog *ngIf="showConfirmationDialog" title="Finalizar cacer√≠a" variant="warning"
    (dismiss)="showConfirmationDialog = false">
    <p class="text-white">¬øEst√°s seguro? Al finalizar la cacer√≠a se eliminar√° f√≠sicamente la estrategia actual y sus
      registros.</p>
    <div actions class="d-flex gap-2 w-100 mt-3">
      <app-glass-button variant="danger" class="flex-grow-1" (click)="confirmEndHunt()">
        S√≠, finalizar
      </app-glass-button>
    </div>
  </app-dialog>
</div>