<div class="min-vh-100">

  <!-- Header limpio -->
  <header class="d-flex align-items-center gap-3 px-4 py-3">
    <button class="btn p-0 border-0 bg-transparent" (click)="onBack()">
      <ion-icon name="arrow-back-outline" class="text-white fs-5"></ion-icon>
    </button>
    <h1 class="text-white fw-bold mt-0 fs-4 text-center w-100">ğŸ“ˆ VERGE Trading</h1>
  </header>

  <main class="px-4 pb-4">

    <!-- Estado de anÃ¡lisis (ÃšNICA secciÃ³n de estado arriba) -->
    <app-card-content class="mb-3 p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <p class="text-white-50 text-xs mb-1">ğŸ•’ Estado del anÃ¡lisis</p>
          <div class="d-flex align-items-center gap-2">
            <div class="rounded-circle" [class]="isHunting ? 'bg-success' : 'bg-secondary'"
              style="width: 10px; height: 10px;"></div>
            <p class="text-white fw-medium mb-0">
              {{ isHunting ? 'CacerÃ­a activa (' + currentSession?.symbol + ')' : 'Sistema en espera' }}
            </p>
          </div>
        </div>

        <div class="text-end">
          <p class="text-white-50 text-xs mb-1">Tiempo activo</p>
          <p class="text-white fw-bold mb-0">{{ analysisTime }}</p>
        </div>
      </div>

      <!-- Indicador visual del stage actual (mini) -->
      <div class="d-flex align-items-center gap-2 mt-3 pt-3 border-top border-white-10">
        <span [class]="'badge bg-' + getCurrentStage().color + ' px-2 py-1'">
          {{ getCurrentStage().label }}
        </span>
        <span class="text-white-50 text-xs">â€¢</span>
        <p class="text-white mb-0 text-xs">{{ getCurrentStage().description }}</p>
      </div>
    </app-card-content>

    <!-- Controles del grÃ¡fico -->
    <app-card-content class="mb-3 p-3">
      <div class="row g-2">
        <div class="col-6">
          <label class="text-white-50 text-xs mb-1 d-block">SÃ­mbolo</label>
          <select class="form-select bg-dark text-white border-dark" [(ngModel)]="selectedSymbol"
            (change)="changeSymbol(selectedSymbol)">
            <option *ngFor="let symbol of symbols" [value]="symbol.value">
              {{ symbol.label }}
            </option>
          </select>
        </div>

        <div class="col-6">
          <label class="text-white-50 text-xs mb-1 d-block">Timeframe</label>
          <select class="form-select bg-dark text-white border-dark" [(ngModel)]="selectedTimeframe"
            (change)="changeTimeframe(selectedTimeframe)">
            <option *ngFor="let tf of timeframes" [value]="tf.value">
              {{ tf.label }}
            </option>
          </select>
        </div>
      </div>
    </app-card-content>

    <!-- SUPER GRÃFICO TradingView con LÃNEAS INTEGRADAS -->
    <app-card-content class="mb-3 p-0 position-relative overflow-hidden bg-dark">

      <!-- GrÃ¡fico TradingView -->
      <div id="tradingview-chart" class="w-100" style="height: 500px;"></div>

      <!-- Leyenda de lÃ­neas (solo en desktop) -->
      <div class="position-absolute top-0 end-0 m-3 z-2 d-none d-md-block">
        <div class="bg-dark bg-opacity-90 rounded-3 p-3 border border-white-10 shadow">
          <p class="text-white fw-medium mb-2 fs-7">ğŸ“Š Progreso del Trade</p>

          <!-- Mini progress bar -->
          <div class="progress mb-2" style="height: 4px;">
            <div [class]="'progress-bar bg-' + getCurrentStage().color" [style.width]="(currentStage * 25) + '%'">
            </div>
          </div>

          <div *ngFor="let stage of stages; let i = index" class="d-flex align-items-center gap-2 mb-1"
            [class.text-white]="i < currentStage" [class.text-white-50]="i >= currentStage">
            <div class="rounded-circle" [style]="'width: 8px; height: 8px; background-color: ' + stage.lineColor"></div>
            <p class="mb-0 fs-7">{{ stage.label }}</p>
            <span *ngIf="stage.price" class="ms-auto fs-7">${{ stage.price.toLocaleString('es-AR') }}</span>
          </div>
        </div>
      </div>
    </app-card-content>

    <!-- Controles de acciÃ³n principales -->
    <div class="mb-3">
      <!-- BotÃ³n INICIAR CAZA (Ya no se usa aquÃ­, se reemplaza por mensaje de guÃ­a) -->
      <app-card-content *ngIf="!isHunting" class="mb-3 p-4 text-center">
        <ion-icon name="flash-outline" class="text-white-50 fs-1 mb-3"></ion-icon>
        <h3 class="text-white mb-2">Â¡Preparado para cazar!</h3>
        <p class="text-white-50 mb-3">ConfigurÃ¡ tu trade en "Ejecutar Trade" para comenzar</p>
        <app-glass-button variant="primary" (click)="onQuickTrade()" class="w-50 mx-auto">
          âš¡ Configurar Trade
        </app-glass-button>
      </app-card-content>

      <!-- BotÃ³n de AcciÃ³n DinÃ¡mico (Cuando la sesiÃ³n estÃ¡ activa) -->
      <app-glass-button *ngIf="isHunting" [variant]="getDynamicCTA().variant" (click)="onExecuteTrade()"
        class="w-full py-3 fw-bold mb-2">
        <div class="d-flex align-items-center justify-content-center gap-2">
          <ion-icon [name]="getCurrentStage().icon"></ion-icon>
          <span>{{ getDynamicCTA().text }}</span>
        </div>
      </app-glass-button>

      <div class="row g-2">
        <div class="col-4">
          <app-glass-button [variant]="isAnalyzing ? 'danger' : 'success'" (click)="toggleAnalysis()"
            class="w-full py-3 px-1">
            <div class="d-flex flex-column align-items-center justify-content-center gap-1">
              <ion-icon [name]="isAnalyzing ? 'pause-outline' : 'play-outline'" class="fs-5"></ion-icon>
              <span class="fs-7">{{ isAnalyzing ? 'Pausar' : 'Reanudar' }}</span>
            </div>
          </app-glass-button>
        </div>

        <div class="col-4">
          <app-glass-button variant="warning" (click)="onQuickTrade()" class="w-full py-3 px-1">
            <div class="d-flex flex-column align-items-center justify-content-center gap-1">
              <ion-icon name="flash-outline" class="fs-5"></ion-icon>
              <span class="fs-7">âš¡ Trade</span>
            </div>
          </app-glass-button>
        </div>

        <div class="col-4">
          <app-glass-button variant="primary" (click)="onOpenAdvanced()" class="w-full py-3 px-1">
            <div class="d-flex flex-column align-items-center justify-content-center gap-1">
              <ion-icon name="stats-chart-outline" class="fs-5"></ion-icon>
              <span class="fs-7">ğŸ“Š Avanzado</span>
            </div>
          </app-glass-button>
        </div>
      </div>
    </div>

    <!-- Consola de AnÃ¡lisis en Vivo -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2 px-2">
        <h3 class="text-white fw-bold mb-0">ğŸ” Consola de AnÃ¡lisis</h3>
        <span class="badge bg-dark text-white">{{ analysisLogs.length }} eventos</span>
      </div>

      <div class="bg-dark rounded-3 p-3 overflow-auto" style="max-height: 400px; font-family: monospace;">
        <div *ngFor="let log of analysisLogs" class="mb-2 pb-2 border-bottom border-white-10"
          [class.text-warning]="log.level === 'warning'" [class.text-success]="log.level === 'success'"
          [class.text-danger]="log.level === 'danger'" [class.text-info]="log.level === 'info'">

          <div class="d-flex align-items-start gap-2">
            <span class="text-white-50" style="min-width: 70px;">{{ log.timestamp | date:'HH:mm:ss' }}</span>
            <span class="flex-grow-1">{{ log.message }}</span>
          </div>

          <!-- Mostrar datos adicionales si existen -->
          <div *ngIf="log.dataJson" class="ms-5 text-white-50 small">
            <span *ngFor="let entry of Object.entries(parseJson(log.dataJson) || {})" class="me-3">
              {{ entry[0] | uppercase }}: {{ entry[1] }}
            </span>
          </div>
        </div>

        <div *ngIf="analysisLogs.length === 0" class="text-white-50 text-center py-3">
          <ion-icon name="scan-outline" class="fs-2 mb-2"></ion-icon>
          <p class="mb-0">Esperando anÃ¡lisis del mercado...</p>
          <p class="text-xs">El sistema evaluarÃ¡ RSI, volumen y noticias cada 1 minuto</p>
        </div>
      </div>
    </div>

    <!-- Info footer -->
    <div class="text-center text-white-50 text-xs mt-4">
      <p class="mb-1">ğŸ“Š GrÃ¡fico por TradingView â€¢ Datos en tiempo real de Binance</p>
      <p class="mb-0">ğŸš€ VERGE Trading System â€¢ Sistema de lÃ­neas integradas 1-2-3-4</p>
    </div>

  </main>
</div>