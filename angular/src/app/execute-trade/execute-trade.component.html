<div class="min-vh-100 pb-4">
    <!-- Header con bot√≥n back y t√≠tulo -->
    <header class="d-flex align-items-center gap-3 px-4 py-4">
        <button class="btn p-0 border-0 bg-transparent" (click)="handleBack()">
            <ion-icon name="arrow-back-outline" class="text-white fs-5"></ion-icon>
        </button>
        <h1 class="text-white fw-bold mt-0 fs-4 text-center w-100">
            Ejecutar Trade
        </h1>
    </header>

    <!-- Contenido principal -->
    <main class="px-4">
        <!-- Card 1: Detalles de la se√±al -->
        <app-card-content class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="text-white fs-5 mb-0">Detalles de la Se√±al</h2>
                <span [class]="'badge bg-' + getStatusColor()">
                    {{ tradeDetails.confidence }}% Confianza
                </span>
            </div>

            <app-card-icon [status]="getStatusColor()"
                [icon]="tradeDetails.direction === 'LONG' ? 'trending-up-outline' : 'trending-down-outline'"
                [useCardContentBg]="true">

                <div class="flex flex-col py-2">
                    <p class="text-white text-sm font-medium mb-0">{{ tradeDetails.symbol }}</p>
                    <p class="text-white-50 text-xs mb-0">
                        {{ tradeDetails.direction }} - Entrada: ${{ tradeDetails.entryPrice | number:'1.2-2' }}
                    </p>
                    <div class="d-flex justify-content-between mt-1">
                        <span class="text-white-50 text-xs">Precio Actual:</span>
                        <span class="text-white text-xs fw-medium">${{ tradeDetails.currentPrice | number:'1.2-2'
                            }}</span>
                    </div>
                </div>
            </app-card-icon>

            <div class="row mt-3 text-white-50 small">
                <div class="col-6">
                    <p class="mb-1">Apalancamiento</p>
                    <p class="text-white fw-bold mb-0">{{ tradeDetails.leverage }}x</p>
                </div>
                <div class="col-6 text-end">
                    <p class="mb-1">Capital Sugerido</p>
                    <p class="text-white fw-bold mb-0">${{ tradeDetails.suggestedAmount }} USDT</p>
                </div>
            </div>
        </app-card-content>

        <!-- Card 2: Configuraci√≥n de trade -->
        <app-card-content class="mb-4">
            <h2 class="text-white fs-5 mb-3">Configuraci√≥n de Trade</h2>

            <!-- Selector de Estilo de Trading -->
            <div class="mb-4">
                <app-label>Estilo de Trading</app-label>

                <!-- Bot√≥n IA Recomendaci√≥n -->
                <div class="mb-3">
                    <app-glass-button variant="primary" class="w-100 py-2 border-primary" (click)="recommendStyle()"
                        [disabled]="isRecommending" [style.--bs-bg-opacity]="isAutoSelected ? '0.3' : '1'">
                        <div class="d-flex align-items-center justify-content-center gap-2">
                            <span *ngIf="isRecommending" class="spinner-border spinner-border-sm" role="status"></span>
                            <ion-icon *ngIf="!isRecommending" name="color-wand-outline"></ion-icon>
                            <span>{{ isRecommending ? 'Analizando mercado...' : 'ü§ñ AUTO (Sugerir el mejor estilo)'
                                }}</span>
                        </div>
                    </app-glass-button>
                    <div *ngIf="isAutoSelected && recommendationReason"
                        class="text-success small mt-2 d-flex align-items-start gap-1 p-2 bg-success bg-opacity-10 rounded border border-success border-opacity-25">
                        <ion-icon name="checkmark-circle-outline" class="mt-1 flex-shrink-0"></ion-icon>
                        <span>{{ recommendationReason }}</span>
                    </div>
                    <div *ngIf="!isAutoSelected && recommendationReason && isRecommending"
                        class="text-info small mt-2 d-flex align-items-start gap-1">
                        <ion-icon name="information-circle-outline" class="mt-1 flex-shrink-0"></ion-icon>
                        <span>{{ recommendationReason }}</span>
                    </div>
                </div>

                <!-- Grid de estilos -->
                <div class="row g-2">
                    <div class="col-6 mb-2" *ngFor="let s of tradingStyles">
                        <div class="card bg-dark border h-100 transition-all" style="cursor: pointer;"
                            [class.border-primary]="request.style === s.value && !isAutoSelected"
                            [class.border-success]="request.style === s.value && isAutoSelected"
                            [class.border-secondary]="request.style !== s.value"
                            [class.bg-primary]="request.style === s.value && !isAutoSelected"
                            [style.--bs-bg-opacity]="request.style === s.value ? '0.2' : '1'"
                            (click)="onStyleSelect(s.value)">
                            <div
                                class="card-body p-2 text-center d-flex flex-column align-items-center justify-content-center">
                                <ion-icon [name]="s.icon" class="fs-4 mb-1"
                                    [class.text-primary]="request.style === s.value && !isAutoSelected"
                                    [class.text-success]="request.style === s.value && isAutoSelected"
                                    [class.text-white-50]="request.style !== s.value"></ion-icon>
                                <span class="text-white small fw-medium mb-0">{{ s.label }}</span>
                                <span class="text-white-50" style="font-size: 0.65rem;">{{ s.desc }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12">
                    <app-label>Criptomoneda</app-label>
                    <select class="form-select bg-dark text-white border-secondary" [(ngModel)]="request.symbol"
                        (change)="onSymbolChange()">
                        <option *ngFor="let s of symbols" [value]="s.value">{{ s.label }}</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3" *ngIf="!isAutoSelected">
                <div class="col-12">
                    <app-label>Direcci√≥n</app-label>
                    <div class="d-flex gap-2">
                        <app-glass-button [variant]="request.direction === 'buy' ? 'success' : 'outline'"
                            class="flex-1 py-2" (click)="request.direction = 'buy'">
                            Compra (LONG)
                        </app-glass-button>
                        <app-glass-button [variant]="request.direction === 'sell' ? 'danger' : 'outline'"
                            class="flex-1 py-2" (click)="request.direction = 'sell'">
                            Venta (SHORT)
                        </app-glass-button>
                        <app-glass-button [variant]="request.direction === 'auto' ? 'primary' : 'outline'"
                            class="flex-1 py-2" (click)="request.direction = 'auto'">
                            üîÑ AUTO
                        </app-glass-button>
                    </div>
                </div>
            </div>

            <div class="row mb-3 text-center" *ngIf="isAutoSelected || request.direction === 'auto'">
                <div class="col-12">
                    <div class="p-3 bg-primary bg-opacity-10 rounded border border-primary border-opacity-25 mt-2">
                        <p
                            class="text-primary-emphasis small mb-0 d-flex align-items-center justify-content-center gap-2">
                            <ion-icon name="sparkles-outline"></ion-icon>
                            <span>
                                Modo <strong>AUTO</strong> Multidimensional: El motor evaluar√° activos, estilos y
                                direcciones para encontrar la mejor entrada.
                            </span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <app-label>Cantidad (USDT)</app-label>
                <input type="number" class="form-control bg-dark text-white border-secondary"
                    [(ngModel)]="request.amount" placeholder="0.00" [min]="10">
            </div>

            <div class="row mb-3">
                <div class="col-6">
                    <app-label>Apalancamiento</app-label>
                    <input type="number" class="form-control bg-dark text-white border-secondary"
                        [(ngModel)]="request.leverage" placeholder="5" [min]="1" [max]="50">
                </div>
                <div class="col-6">
                    <app-label>Tipo de Orden</app-label>
                    <select class="form-select bg-dark text-white border-secondary" [(ngModel)]="request.orderType">
                        <option value="market">Market</option>
                        <option value="limit">Limit</option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-6">
                    <app-label>Take Profit (%)</app-label>
                    <input type="number" class="form-control bg-dark text-white border-secondary"
                        [(ngModel)]="request.takeProfit" placeholder="5" [min]="1" [max]="50">
                </div>
                <div class="col-6">
                    <app-label>Stop Loss (%)</app-label>
                    <input type="number" class="form-control bg-dark text-white border-secondary"
                        [(ngModel)]="request.stopLoss" placeholder="2" [min]="1" [max]="20">
                </div>
            </div>

            <div class="d-flex align-items-center gap-2 mt-3">
                <input type="checkbox" id="confirm" class="form-check-input" checked>
                <label for="confirm" class="text-white-50 small mb-0">
                    Confirmo que entiendo los riesgos del trading con apalancamiento
                </label>
            </div>
        </app-card-content>

        <!-- Card 3: Resumen de riesgo -->
        <app-card-content class="mb-4">
            <h2 class="text-white fs-5 mb-3">Resumen de Riesgo</h2>

            <div class="d-flex justify-content-between mb-2">
                <span class="text-white-50">Margen requerido</span>
                <span class="text-white">${{ getRiskSummary().margin | number:'1.2-2' }} USDT</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span class="text-white-50 text-success">Ganancia estimada</span>
                <span class="text-success">+${{ getRiskSummary().potentialProfit | number:'1.2-2' }} USDT</span>
            </div>
            <div class="d-flex justify-content-between">
                <span class="text-white-50 text-danger">P√©rdida m√°xima</span>
                <span class="text-danger">-${{ getRiskSummary().potentialLoss | number:'1.2-2' }} USDT</span>
            </div>
        </app-card-content>

        <!-- Botones -->
        <div class="d-grid gap-3">
            <app-glass-button [variant]="(hasActiveHunt || isExecuting) ? 'outline' : 'solid'"
                [disabled]="hasActiveHunt || isExecuting" class="w-full py-3"
                (click)="(!hasActiveHunt && !isExecuting) && executeTrade()">
                <div class="d-flex align-items-center justify-content-center gap-2">
                    <ion-icon *ngIf="!isExecuting" name="flash-outline"></ion-icon>
                    <div *ngIf="isExecuting" class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span>
                        {{ isExecuting ? 'Creando cacer√≠a...' : (hasActiveHunt ? 'Cacer√≠a en curso' : 'üöÄ Ejecutar
                        Trade') }}
                    </span>
                </div>
            </app-glass-button>
            <app-glass-button variant="outline" class="w-full py-3" [disabled]="isExecuting"
                (click)="!isExecuting && cancelTrade()">
                Cancelar
            </app-glass-button>
        </div>

        <!-- Di√°logo Bloqueante -->
        <app-dialog *ngIf="showBlockingDialog" title="Cacer√≠a Activa" variant="warning"
            (dismiss)="closeBlockingDialog()">
            <p class="text-white">Ya ten√©s una cacer√≠a activa. Finalizala desde el dashboard antes de crear una nueva.
            </p>
            <div actions class="w-100 mt-3">
                <app-glass-button variant="primary" class="w-100" (click)="closeBlockingDialog()">
                    Ir al Dashboard
                </app-glass-button>
            </div>
        </app-dialog>

        <!-- Info adicional -->
        <div class="text-center text-white-50 text-xs mt-4">
            <p class="mb-1">‚ö†Ô∏è Trading con apalancamiento implica alto riesgo</p>
            <p class="mb-0">M√°ximo riesgo: {{ getRiskSummary().potentialLoss / request.amount * 100 | number:'1.1-1' }}%
                del capital</p>
        </div>
    </main>
</div>